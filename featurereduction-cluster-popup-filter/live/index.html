<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <title>Point clustering - filter popup features | Sample | ArcGIS Maps SDK for JavaScript 4.25</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.25/"></script>

    <style>
      html,
      body,
      #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

    <script>
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/smartMapping/labels/clusters"
      ], function (
        WebMap,
        MapView,
        FeatureLayer,
        Legend,
        Expand,
        clusterLabelCreator
      ) {

        const layer = new FeatureLayer({
          portalItem: {
            id: "eb54b44c65b846cca12914b87b315169"
          }
        });

        const map = new WebMap({
          basemap: {
            portalItem: {
              id: "75a08e8cd8b64dcfa6945bb7f624ccc5"
            }
          },
          layers: [layer]
        });

        const view = new MapView({
          container: "viewDiv",
          map,
          extent: {
            spatialReference: {
              latestWkid: 3857,
              wkid: 102100
            },
            xmin: -15327459,
            ymin: 2740044,
            xmax: -6076744,
            ymax: 6878650
          },
          popup: {
            dockEnabled: true,
            dockOptions: {
              breakpoint: false,
              position: "top-right"
            }
          }
        });

        view.ui.add(
          new Expand({
            content: new Legend({ view }),
            view
          }),
          "top-left"
        );

        layer
          .when()
          .then(generateClusterConfig)
          .then(async (featureReduction) => {
            // sets generated cluster configuration on the layer
            layer.featureReduction = featureReduction;

            // Disable clustering when user zooms beyond a 1:50,000 scale level
            // Re-enable clustering when the user zooms out to a scale smaller than 1:50,000
            view.watch("scale", function (scale) {
              layer.featureReduction =
                view.scale > 50000 ? featureReduction : null;
            });
          })
          .catch((error) => {
            console.error(error);
          });

        async function generateClusterConfig(layer) {

          let popupTemplate = {
            title: "Coal summary",
            content: `<p>This cluster represents <b>{cluster_count}</b> power plants. <b>{expression/Coal-count}</b> of these plants are fueled by Coal.</p><p>Coal plants produce <b>{expression/Coal-mw-sum}</b> of the total power generated in this cluster.</p>`,
            expressionInfos: [{
              name: "Coal-count",
              title: "Coal-count",
              expression: `
                // returns the total number of coal power plants
                Count(Filter($aggregatedFeatures, "fuel1 = 'Coal'"))
              `
            }, {
              name: "Coal-mw-sum",
              title: "Coal-mw-sum",
              expression: `
                // returns the amount of electricity generated by coal
                // in this cluster as a ratio to the total capacity
                // of plants included in the cluster
                Expects($aggregatedFeatures, "capacity_mw")
                var mWtotal = Sum($aggregatedFeatures, "capacity_mw");
                var mWCoal = Sum(Filter($aggregatedFeatures, "fuel1 = 'Coal'"), "capacity_mw");
                if(mWCoal < 1){
                  return "none";
                }
                var mWratio = Round(mWCoal / mWtotal, 4);
                return \`\${Text(mWratio, "#.#%")} (\${Text(mWCoal, "#,### mW")})\`;
              `
            }]
          };


          // generates default labelingInfo
          const { labelingInfo, clusterMinSize } = await clusterLabelCreator
            .getLabelSchemes({
              layer,
              view
            })
            .then((labelSchemes) => labelSchemes.primaryScheme);

          return {
            type: "cluster",
            popupTemplate,
            labelingInfo,
            clusterMinSize
          };
        }
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
